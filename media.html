<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gallery</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="card" style="max-width:1100px; margin:0 auto;">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
      <div>
        <div class="pill">üñºÔ∏è Gallery</div>
        <h1 style="margin-top:10px;">Gallery</h1>
        <div class="muted">Photos + videos. Click to open. Select to delete.</div>
      </div>
      <div class="rowBtns">
        <a class="btn" href="home.html">‚¨Ö Home</a>
        <button class="btn btnPrimary" id="addOpen">‚ûï Add Media</button>
        <button class="btn" id="toggleSelect">‚úÖ Select</button>
        <button class="btn" id="deleteSelected" style="display:none;">üóë Delete selected</button>
      </div>
    </div>

    <div class="hr"></div>

    <div class="galleryGrid" id="grid"></div>
    <div class="muted" id="empty" style="display:none; margin-top:10px;">No media yet.</div>
  </div>

  <script src="app.js"></script>
  <script>
    requireUnlocked();

    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const addOpen = document.getElementById("addOpen");
    const toggleSelect = document.getElementById("toggleSelect");
    const deleteSelected = document.getElementById("deleteSelected");

    let selectMode = false;

    function render(){
      const media = getAllMedia();
      grid.innerHTML = "";

      if (!media.length){
        empty.style.display = "block";
        return;
      }
      empty.style.display = "none";

      media.forEach(item => {
        const wrap = document.createElement("div");
        wrap.className = "gItem";

        wrap.addEventListener("click", (e) => {
          // if selecting, don't open lightbox
          if (selectMode) return;
          openLightbox(item);
        });

        const checkbox = `<input class="check" type="checkbox" data-id="${item.id}" style="display:${selectMode ? "block":"none"}">`;

        if (item.type === "image"){
          wrap.innerHTML = `
            ${checkbox}
            <img class="media" src="${item.dataUrl}" alt="photo">
          `;
        } else {
          wrap.innerHTML = `
            ${checkbox}
            <video class="media" src="${item.dataUrl}" muted playsinline preload="metadata"></video>
            <div class="playBadge">‚ñ∂ video</div>
          `;
        }

        grid.appendChild(wrap);
      });

      deleteSelected.style.display = selectMode ? "inline-flex" : "none";
      toggleSelect.textContent = selectMode ? "‚ùå Done" : "‚úÖ Select";
    }

    function openAddMediaModal(){
      const { inner } = openModal(`
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h2 style="margin:0;">‚ûï Add Media</h2>
          <button class="btn" id="closeX">‚úï</button>
        </div>
        <div class="hr"></div>

        <label class="muted" style="font-weight:900;">Pick photos or videos</label>
        <input id="file" type="file" accept="image/*,video/*" multiple />

        <div class="rowBtns">
          <button class="btn btnPrimary" id="save">Save</button>
          <button class="btn" id="cancel">Cancel</button>
        </div>

        <div class="muted" style="margin-top:10px;">
          Tip: Videos should be short (storage limit).
        </div>
      `);

      inner.querySelector("#closeX").addEventListener("click", closeModal);
      inner.querySelector("#cancel").addEventListener("click", closeModal);

      const fileEl = inner.querySelector("#file");

      inner.querySelector("#save").addEventListener("click", async () => {
        const files = Array.from(fileEl.files || []);
        if (!files.length){ closeModal(); return; }

        const list = loadMedia();

        for (const f of files){
          const dataUrl = await fileToDataURL(f);

          if (f.type.startsWith("image")){
            list.push({ id: uid(), type:"image", dataUrl, createdAt: Date.now() });
          } else if (f.type.startsWith("video")){
            list.push({ id: uid(), type:"video", dataUrl, createdAt: Date.now() });
          }
        }

        saveMedia(list);
        closeModal();
        render();
      });
    }

    addOpen.addEventListener("click", openAddMediaModal);

    toggleSelect.addEventListener("click", () => {
      selectMode = !selectMode;
      render();
    });

    deleteSelected.addEventListener("click", () => {
      const checks = Array.from(document.querySelectorAll('input.check:checked'));
      const ids = new Set(checks.map(c => c.getAttribute("data-id")));

      if (!ids.size) return;

      const list = loadMedia().filter(x => !ids.has(x.id));
      saveMedia(list);
      render();
    });

    render();
  </script>
</body>
</html>
