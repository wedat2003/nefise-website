<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Events</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="card" style="max-width:980px; margin:0 auto;">
    <div style="display:flex; justify-content:space-between; gap:12px; align-items:center;">
      <div>
        <div class="pill">ðŸ“… Events</div>
        <h1 style="margin-top:10px;">Events</h1>
        <div class="muted">Latest event shows on Home + pops up on unlock.</div>
      </div>
      <div class="rowBtns">
        <a class="btn" href="home.html">â¬… Home</a>
        <button class="btn btnPrimary" id="addOpen">âž• Add Event</button>
      </div>
    </div>

    <div class="hr"></div>

    <h2>All events</h2>
    <div class="list" id="feed"></div>
  </div>

  <script src="app.js"></script>
  <script>
    requireUnlocked();

    const feedEl = document.getElementById("feed");
    const addOpen = document.getElementById("addOpen");

    function render(){
      const events = loadEvents().sort((a,b)=> b.createdAt - a.createdAt);
      feedEl.innerHTML = "";

      if (!events.length){
        feedEl.innerHTML = `<div class="muted">No events yet.</div>`;
        return;
      }

      events.forEach((e, idx) => {
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div style="display:flex; justify-content:space-between; gap:12px; align-items:flex-start;">
            <div style="min-width:0;">
              <div class="itemTitle">${escapeHtml(e.title || "Event")}</div>
              <div class="itemMeta">Event: ${localDateFromInput(e.eventLocal).toLocaleString()}</div>
              <div class="itemMeta">Created: ${new Date(e.createdAt).toLocaleString()}</div>
            </div>
            <button class="btn" data-del="${idx}">ðŸ—‘</button>
          </div>
          <div class="itemText">${escapeHtml(e.text || "")}</div>
          ${mediaHTML(e.media)}
        `;
        feedEl.appendChild(el);
      });

      feedEl.querySelectorAll("[data-del]").forEach(b => {
        b.addEventListener("click", () => {
          const events = loadEvents().sort((a,b)=> b.createdAt - a.createdAt);
          const idx = Number(b.getAttribute("data-del"));
          events.splice(idx, 1);
          saveEvents(events);
          render();
        });
      });
    }

    function openAddEventModal(){
      const { inner } = openModal(`
        <div style="display:flex; justify-content:space-between; align-items:center; gap:12px;">
          <h2 style="margin:0;">âž• Add Event</h2>
          <button class="btn" id="closeX">âœ•</button>
        </div>
        <div class="hr"></div>

        <input id="title" placeholder="Title" />
        <div style="height:10px;"></div>

        <label class="muted" style="font-weight:900;">Event date</label>
        <input id="eventDate" type="datetime-local" />

        <div style="height:10px;"></div>
        <textarea id="text" placeholder="Message..."></textarea>

        <div style="height:10px;"></div>
        <label class="muted" style="font-weight:900;">Attachment (optional)</label>
        <input id="file" type="file" accept="image/*,video/*" />
        <div id="prev"></div>

        <div class="rowBtns">
          <button class="btn btnPrimary" id="save">Save</button>
          <button class="btn" id="cancel">Cancel</button>
        </div>
        <div class="error" id="err">Please fill title, date and message.</div>
      `);

      inner.querySelector("#closeX").addEventListener("click", closeModal);
      inner.querySelector("#cancel").addEventListener("click", closeModal);

      const titleEl = inner.querySelector("#title");
      const dateEl  = inner.querySelector("#eventDate");
      const textEl  = inner.querySelector("#text");
      const fileEl  = inner.querySelector("#file");
      const prevEl  = inner.querySelector("#prev");
      const errEl   = inner.querySelector("#err");

      let pendingMedia = null;

      fileEl.addEventListener("change", async () => {
        const f = fileEl.files && fileEl.files[0];
        pendingMedia = null;
        prevEl.innerHTML = "";
        if (!f) return;

        const dataUrl = await fileToDataURL(f);
        const type = f.type.startsWith("video") ? "video" : "image";
        pendingMedia = { type, dataUrl, name: f.name };
        prevEl.innerHTML = mediaHTML(pendingMedia);
      });

      inner.querySelector("#save").addEventListener("click", () => {
        const title = titleEl.value.trim();
        const dt = dateEl.value;
        const text = textEl.value.trim();
        if (!title || !dt || !text){ errEl.style.display="block"; return; }
        errEl.style.display="none";

        const events = loadEvents();
        events.push({
          title,
          text,
          eventLocal: dt,      // store as datetime-local string
          createdAt: Date.now(),
          media: pendingMedia
        });
        saveEvents(events);

        closeModal();
        render();
      });
    }

    addOpen.addEventListener("click", openAddEventModal);
    render();
  </script>
</body>
</html>
